// Generated by CoffeeScript 1.6.3
(function() {
  var Collection, Instance, Singleton, Spine, association, isArray, require, singularize, underscore,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Spine = this.Spine || require('spine');

  isArray = Spine.isArray;

  require = this.require || (function(value) {
    return eval(value);
  });

  Collection = (function(_super) {
    __extends(Collection, _super);

    function Collection(options) {
      var key, value;
      if (options == null) {
        options = {};
      }
      for (key in options) {
        value = options[key];
        this[key] = value;
      }
    }

    Collection.prototype.all = function() {
      var _this = this;
      return this.model.select(function(rec) {
        return _this.associated(rec);
      });
    };

    Collection.prototype.first = function() {
      return this.all()[0];
    };

    Collection.prototype.last = function() {
      var values;
      values = this.all();
      return values[values.length - 1];
    };

    Collection.prototype.count = function() {
      return this.all().length;
    };

    Collection.prototype.find = function(id) {
      var records,
        _this = this;
      records = this.select(function(rec) {
        return ("" + rec.id) === ("" + id);
      });
      if (!records[0]) {
        throw new Error("\"" + this.model.className + "\" model could not find a record for the ID \"" + id + "\"");
      }
      return records[0];
    };

    Collection.prototype.findAllByAttribute = function(name, value) {
      var _this = this;
      return this.model.select(function(rec) {
        return _this.associated(rec) && rec[name] === value;
      });
    };

    Collection.prototype.findByAttribute = function(name, value) {
      return this.findAllByAttribute(name, value)[0];
    };

    Collection.prototype.select = function(cb) {
      var _this = this;
      return this.model.select(function(rec) {
        return _this.associated(rec) && cb(rec);
      });
    };

    Collection.prototype.refresh = function(values) {
      var i, match, record, _i, _j, _k, _len, _len1, _len2, _ref, _ref1;
      if (values == null) {
        return this;
      }
      _ref = this.all();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        record = _ref[_i];
        delete this.model.irecords[record.id];
        _ref1 = this.model.records;
        for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
          match = _ref1[i];
          if (!(match.id === record.id)) {
            continue;
          }
          this.model.records.splice(i, 1);
          break;
        }
      }
      if (!isArray(values)) {
        values = [values];
      }
      for (_k = 0, _len2 = values.length; _k < _len2; _k++) {
        record = values[_k];
        record.newRecord = false;
        record[this.fkey] = this.record.id;
      }
      this.model.refresh(values);
      return this;
    };

    Collection.prototype.create = function(record, options) {
      record[this.fkey] = this.record.id;
      return this.model.create(record, options);
    };

    Collection.prototype.add = function(record, options) {
      return record.updateAttribute(this.fkey, this.record.id, options);
    };

    Collection.prototype.remove = function(record, options) {
      return record.updateAttribute(this.fkey, null, options);
    };

    Collection.prototype.associated = function(record) {
      return record[this.fkey] === this.record.id;
    };

    return Collection;

  })(Spine.Module);

  Instance = (function(_super) {
    __extends(Instance, _super);

    function Instance(options) {
      var key, value;
      if (options == null) {
        options = {};
      }
      for (key in options) {
        value = options[key];
        this[key] = value;
      }
    }

    Instance.prototype.exists = function() {
      if (this.record[this.fkey]) {
        return this.model.exists(this.record[this.fkey]);
      } else {
        return false;
      }
    };

    Instance.prototype.update = function(value) {
      if (value == null) {
        return this;
      }
      if (!(value instanceof this.model)) {
        value = new this.model(value);
      }
      if (value.isNew()) {
        value.save();
      }
      this.record[this.fkey] = value && value.id;
      return this;
    };

    return Instance;

  })(Spine.Module);

  Singleton = (function(_super) {
    __extends(Singleton, _super);

    function Singleton(options) {
      var key, value;
      if (options == null) {
        options = {};
      }
      for (key in options) {
        value = options[key];
        this[key] = value;
      }
    }

    Singleton.prototype.find = function() {
      return this.record.id && this.model.findByAttribute(this.fkey, this.record.id);
    };

    Singleton.prototype.update = function(value) {
      if (value == null) {
        return this;
      }
      if (!(value instanceof this.model)) {
        value = this.model.fromJSON(value);
      }
      value[this.fkey] = this.record.id;
      value.save();
      return this;
    };

    return Singleton;

  })(Spine.Module);

  singularize = function(str) {
    return str.replace(/s$/, '');
  };

  underscore = function(str) {
    return str.replace(/::/g, '/').replace(/([A-Z]+)([A-Z][a-z])/g, '$1_$2').replace(/([a-z\d])([A-Z])/g, '$1_$2').replace(/-/g, '_').toLowerCase();
  };

  association = function(name, model, record, fkey, Ctor) {
    if (typeof model === 'string') {
      model = require(model);
    }
    return new Ctor({
      name: name,
      model: model,
      record: record,
      fkey: fkey
    });
  };

  Spine.Model.extend({
    hasMany: function(name, model, fkey) {
      if (fkey == null) {
        fkey = "" + (underscore(this.className)) + "_id";
      }
      return this.prototype[name] = function(value) {
        return association(name, model, this, fkey, Collection).refresh(value);
      };
    },
    belongsTo: function(name, model, fkey) {
      if (fkey == null) {
        fkey = "" + (underscore(singularize(name))) + "_id";
      }
      this.prototype[name] = function(value) {
        return association(name, model, this, fkey, Instance).update(value).exists();
      };
      return this.attributes.push(fkey);
    },
    hasOne: function(name, model, fkey) {
      if (fkey == null) {
        fkey = "" + (underscore(this.className)) + "_id";
      }
      return this.prototype[name] = function(value) {
        return association(name, model, this, fkey, Singleton).update(value).find();
      };
    }
  });

  Spine.Collection = Collection;

  Spine.Singleton = Singleton;

  Spine.Instance = Instance;

}).call(this);

/*
//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpb24uanMiLCJzb3VyY2VSb290IjoiLi4iLCJzb3VyY2VzIjpbInNyYy9yZWxhdGlvbi5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0NBQUEsS0FBQSx3RkFBQTtLQUFBO29TQUFBOztDQUFBLENBQUEsQ0FBVSxDQUFDLENBQVgsRUFBb0I7O0NBQXBCLENBQ0EsQ0FBVSxFQUFLLEVBQWY7O0NBREEsQ0FFQSxDQUFVLENBQUMsQ0FBWSxFQUF2QixFQUF3QjtDQUFlLEdBQUwsQ0FBQSxNQUFBO0NBQVosRUFBQzs7Q0FGdkIsQ0FJTTtDQUNKOztDQUFhLEVBQUEsQ0FBQSxHQUFBLGFBQUM7Q0FDWixTQUFBOztHQURzQixLQUFWO1FBQ1o7QUFBQSxDQUFBLFVBQUEsR0FBQTs4QkFBQTtDQUNFLEVBQUUsQ0FBQSxDQUFGLEdBQUE7Q0FERixNQURXO0NBQWIsSUFBYTs7Q0FBYixFQUlBLE1BQUs7Q0FDSCxTQUFBLEVBQUE7Q0FBQyxFQUFhLENBQWIsQ0FBSyxDQUFOLEdBQWUsSUFBZjtDQUF3QixFQUFELEVBQUMsS0FBRCxLQUFBO0NBQXZCLE1BQWM7Q0FMaEIsSUFJSzs7Q0FKTCxFQU9PLEVBQVAsSUFBTztDQUNKLEVBQUQsQ0FBQyxTQUFEO0NBUkYsSUFPTzs7Q0FQUCxFQVVNLENBQU4sS0FBTTtDQUNKLEtBQUEsSUFBQTtDQUFBLEVBQVMsQ0FBQyxFQUFWO0NBQ08sRUFBZ0IsR0FBaEIsT0FBUDtDQVpGLElBVU07O0NBVk4sRUFjTyxFQUFQLElBQU87Q0FDSixFQUFELENBQUMsU0FBRDtDQWZGLElBY087O0NBZFAsQ0FpQk0sQ0FBQSxDQUFOLEtBQU87Q0FDTCxNQUFBLEdBQUE7U0FBQSxHQUFBO0NBQUEsRUFBVSxDQUFDLEVBQVgsQ0FBQSxFQUFtQjtDQUNqQixDQUFBLENBQUUsRUFBYSxVQUFmO0NBRFEsTUFBUTtBQUVtRixDQUFyRyxHQUFBLEVBQUEsQ0FBNkc7Q0FBN0csQ0FBaUIsQ0FBRyxDQUFWLENBQUEsSUFBTyxLQUFQLGtD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QUEsQ0FBQSxJQUFBO0NBSEssTUFFSztDQUZkLElBQVM7Q0FBVCxDQUtXLENBQUEsQ0FBWCxDQUFXLElBQVg7O0NBQ1ksQ0FBRixDQUFBLENBQWEsSUFBckIsRUFBVSxDQUFXO1FBQXJCO0NBQUEsRUFDWSxDQUFYLENBQVcsQ0FBWixHQUFJO0NBQ1UsQ0FBTSxFQUFsQixDQUFBLENBQUEsRUFBQSxHQUFBLElBQUE7Q0FGRixNQUNZO0NBR1gsR0FBQSxNQUFVLEdBQVg7Q0FWRixJQUtXO0NBTFgsQ0FZUSxDQUFBLENBQVIsQ0FBUSxDQUFSLEdBQVM7O0NBQ0csQ0FBRixDQUFBLENBQWMsSUFBdEIsQ0FBVSxDQUFBO1FBQVY7Q0FDQyxFQUFXLENBQVgsQ0FBVyxJQUFSLElBQUo7Q0FDYyxDQUFNLEVBQWxCLENBQUEsQ0FBQSxHQUFBLEVBQUEsSUFBQTtDQUhJLE1BRU07Q0FkZCxJQVlRO0NBaElWLEdBbUhBOztDQW5IQSxDQXFJQSxDQUFtQixFQUFkLEtBQUw7O0NBcklBLENBc0lBLENBQWtCLEVBQWIsSUFBTDs7Q0F0SUEsQ0F1SUEsQ0FBaUIsRUFBWixHQUFMO0NBdklBIiwic291cmNlc0NvbnRlbnQiOlsiU3BpbmUgICA9IEBTcGluZSBvciByZXF1aXJlKCdzcGluZScpXG5pc0FycmF5ID0gU3BpbmUuaXNBcnJheVxucmVxdWlyZSA9IEByZXF1aXJlIG9yICgodmFsdWUpIC0+IGV2YWwodmFsdWUpKVxuXG5jbGFzcyBDb2xsZWN0aW9uIGV4dGVuZHMgU3BpbmUuTW9kdWxlXG4gIGNvbnN0cnVjdG9yOiAob3B0aW9ucyA9IHt9KSAtPlxuICAgIGZvciBrZXksIHZhbHVlIG9mIG9wdGlvbnNcbiAgICAgIEBba2V5XSA9IHZhbHVlXG5cbiAgYWxsOiAtPlxuICAgIEBtb2RlbC5zZWxlY3QgKHJlYykgPT4gQGFzc29jaWF0ZWQocmVjKVxuXG4gIGZpcnN0OiAtPlxuICAgIEBhbGwoKVswXVxuXG4gIGxhc3Q6IC0+XG4gICAgdmFsdWVzID0gQGFsbCgpXG4gICAgdmFsdWVzW3ZhbHVlcy5sZW5ndGggLSAxXVxuXG4gIGNvdW50OiAtPlxuICAgIEBhbGwoKS5sZW5ndGhcblxuICBmaW5kOiAoaWQpIC0+XG4gICAgcmVjb3JkcyA9IEBzZWxlY3QgKHJlYykgPT5cbiAgICAgIFwiI3tyZWMuaWR9XCIgaXMgXCIje2lkfVwiXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiXFxcIiN7QG1vZGVsLmNsYXNzTmFtZX1cXFwiIG1vZGVsIGNvdWxkIG5vdCBmaW5kIGEgcmVjb3JkIGZvciB0aGUgSUQgXFxcIiN7aWR9XFxcIlwiKSB1bmxlc3MgcmVjb3Jkc1swXVxuICAgIHJlY29yZHNbMF1cblxuICBmaW5kQWxsQnlBdHRyaWJ1dGU6IChuYW1lLCB2YWx1ZSkgLT5cbiAgICBAbW9kZWwuc2VsZWN0IChyZWMpID0+XG4gICAgICBAYXNzb2NpYXRlZChyZWMpIGFuZCByZWNbbmFtZV0gaXMgdmFsdWVcblxuICBmaW5kQnlBdHRyaWJ1dGU6IChuYW1lLCB2YWx1ZSkgLT5cbiAgICBAZmluZEFsbEJ5QXR0cmlidXRlKG5hbWUsIHZhbHVlKVswXVxuXG4gIHNlbGVjdDogKGNiKSAtPlxuICAgIEBtb2RlbC5zZWxlY3QgKHJlYykgPT5cbiAgICAgIEBhc3NvY2lhdGVkKHJlYykgYW5kIGNiKHJlYylcblxuICByZWZyZXNoOiAodmFsdWVzKSAtPlxuICAgIHJldHVybiB0aGlzIHVubGVzcyB2YWx1ZXM/XG4gICAgZm9yIHJlY29yZCBpbiBAYWxsKClcbiAgICAgIGRlbGV0ZSBAbW9kZWwuaXJlY29yZHNbcmVjb3JkLmlkXVxuICAgICAgZm9yIG1hdGNoLCBpIGluIEBtb2RlbC5yZWNvcmRzIHdoZW4gbWF0Y2guaWQgaXMgcmVjb3JkLmlkXG4gICAgICAgIEBtb2RlbC5yZWNvcmRzLnNwbGljZShpLCAxKVxuICAgICAgICBicmVha1xuICAgIHZhbHVlcyA9IFt2YWx1ZXNdIHVubGVzcyBpc0FycmF5KHZhbHVlcylcbiAgICBmb3IgcmVjb3JkIGluIHZhbHVlc1xuICAgICAgcmVjb3JkLm5ld1JlY29yZCA9IGZhbHNlXG4gICAgICByZWNvcmRbQGZrZXldID0gQHJlY29yZC5pZFxuICAgIEBtb2RlbC5yZWZyZXNoIHZhbHVlc1xuICAgIHRoaXNcblxuICBjcmVhdGU6IChyZWNvcmQsIG9wdGlvbnMpIC0+XG4gICAgcmVjb3JkW0Bma2V5XSA9IEByZWNvcmQuaWRcbiAgICBAbW9kZWwuY3JlYXRlKHJlY29yZCwgb3B0aW9ucylcblxuICBhZGQ6IChyZWNvcmQsIG9wdGlvbnMpIC0+XG4gICAgcmVjb3JkLnVwZGF0ZUF0dHJpYnV0ZSBAZmtleSwgQHJlY29yZC5pZCwgb3B0aW9uc1xuXG4gIHJlbW92ZTogKHJlY29yZCwgb3B0aW9ucykgLT5cbiAgICByZWNvcmQudXBkYXRlQXR0cmlidXRlIEBma2V5LCBudWxsLCBvcHRpb25zXG5cbiAgIyBQcml2YXRlXG5cbiAgYXNzb2NpYXRlZDogKHJlY29yZCkgLT5cbiAgICByZWNvcmRbQGZrZXldIGlzIEByZWNvcmQuaWRcblxuY2xhc3MgSW5zdGFuY2UgZXh0ZW5kcyBTcGluZS5Nb2R1bGVcbiAgY29uc3RydWN0b3I6IChvcHRpb25zID0ge30pIC0+XG4gICAgZm9yIGtleSwgdmFsdWUgb2Ygb3B0aW9uc1xuICAgICAgQFtrZXldID0gdmFsdWVcblxuICBleGlzdHM6IC0+XG4gICAgcmV0dXJuIGlmIEByZWNvcmRbQGZrZXldIHRoZW4gQG1vZGVsLmV4aXN0cyhAcmVjb3JkW0Bma2V5XSkgZWxzZSBmYWxzZVxuXG4gIHVwZGF0ZTogKHZhbHVlKSAtPlxuICAgIHJldHVybiB0aGlzIHVubGVzcyB2YWx1ZT9cbiAgICB1bmxlc3MgdmFsdWUgaW5zdGFuY2VvZiBAbW9kZWxcbiAgICAgIHZhbHVlID0gbmV3IEBtb2RlbCh2YWx1ZSlcbiAgICB2YWx1ZS5zYXZlKCkgaWYgdmFsdWUuaXNOZXcoKVxuICAgIEByZWNvcmRbQGZrZXldID0gdmFsdWUgYW5kIHZhbHVlLmlkXG4gICAgdGhpc1xuXG5jbGFzcyBTaW5nbGV0b24gZXh0ZW5kcyBTcGluZS5Nb2R1bGVcbiAgY29uc3RydWN0b3I6IChvcHRpb25zID0ge30pIC0+XG4gICAgZm9yIGtleSwgdmFsdWUgb2Ygb3B0aW9uc1xuICAgICAgQFtrZXldID0gdmFsdWVcblxuICBmaW5kOiAtPlxuICAgIEByZWNvcmQuaWQgYW5kIEBtb2RlbC5maW5kQnlBdHRyaWJ1dGUoQGZrZXksIEByZWNvcmQuaWQpXG5cbiAgdXBkYXRlOiAodmFsdWUpIC0+XG4gICAgcmV0dXJuIHRoaXMgdW5sZXNzIHZhbHVlP1xuICAgIHVubGVzcyB2YWx1ZSBpbnN0YW5jZW9mIEBtb2RlbFxuICAgICAgdmFsdWUgPSBAbW9kZWwuZnJvbUpTT04odmFsdWUpXG5cbiAgICB2YWx1ZVtAZmtleV0gPSBAcmVjb3JkLmlkXG4gICAgdmFsdWUuc2F2ZSgpXG4gICAgdGhpc1xuXG5zaW5ndWxhcml6ZSA9IChzdHIpIC0+XG4gIHN0ci5yZXBsYWNlKC9zJC8sICcnKVxuXG51bmRlcnNjb3JlID0gKHN0cikgLT5cbiAgc3RyLnJlcGxhY2UoLzo6L2csICcvJylcbiAgICAgLnJlcGxhY2UoLyhbQS1aXSspKFtBLVpdW2Etel0pL2csICckMV8kMicpXG4gICAgIC5yZXBsYWNlKC8oW2EtelxcZF0pKFtBLVpdKS9nLCAnJDFfJDInKVxuICAgICAucmVwbGFjZSgvLS9nLCAnXycpXG4gICAgIC50b0xvd2VyQ2FzZSgpXG5cbmFzc29jaWF0aW9uID0gKG5hbWUsIG1vZGVsLCByZWNvcmQsIGZrZXksIEN0b3IpIC0+XG4gIG1vZGVsID0gcmVxdWlyZShtb2RlbCkgaWYgdHlwZW9mIG1vZGVsIGlzICdzdHJpbmcnXG4gIG5ldyBDdG9yKG5hbWU6IG5hbWUsIG1vZGVsOiBtb2RlbCwgcmVjb3JkOiByZWNvcmQsIGZrZXk6IGZrZXkpXG5cblNwaW5lLk1vZGVsLmV4dGVuZFxuICBoYXNNYW55OiAobmFtZSwgbW9kZWwsIGZrZXkpIC0+XG4gICAgZmtleSA/PSBcIiN7dW5kZXJzY29yZSh0aGlzLmNsYXNzTmFtZSl9X2lkXCJcbiAgICBAOjpbbmFtZV0gPSAodmFsdWUpIC0+XG4gICAgICBhc3NvY2lhdGlvbihuYW1lLCBtb2RlbCwgQCwgZmtleSwgQ29sbGVjdGlvbikucmVmcmVzaCh2YWx1ZSlcblxuICBiZWxvbmdzVG86IChuYW1lLCBtb2RlbCwgZmtleSkgLT5cbiAgICBma2V5ID89IFwiI3t1bmRlcnNjb3JlKHNpbmd1bGFyaXplKG5hbWUpKX1faWRcIlxuICAgIEA6OltuYW1lXSA9ICh2YWx1ZSkgLT5cbiAgICAgIGFzc29jaWF0aW9uKG5hbWUsIG1vZGVsLCBALCBma2V5LCBJbnN0YW5jZSkudXBkYXRlKHZhbHVlKS5leGlzdHMoKVxuXG4gICAgQGF0dHJpYnV0ZXMucHVzaChma2V5KVxuXG4gIGhhc09uZTogKG5hbWUsIG1vZGVsLCBma2V5KSAtPlxuICAgIGZrZXkgPz0gXCIje3VuZGVyc2NvcmUoQGNsYXNzTmFtZSl9X2lkXCJcbiAgICBAOjpbbmFtZV0gPSAodmFsdWUpIC0+XG4gICAgICBhc3NvY2lhdGlvbihuYW1lLCBtb2RlbCwgQCwgZmtleSwgU2luZ2xldG9uKS51cGRhdGUodmFsdWUpLmZpbmQoKVxuXG5TcGluZS5Db2xsZWN0aW9uID0gQ29sbGVjdGlvblxuU3BpbmUuU2luZ2xldG9uID0gU2luZ2xldG9uXG5TcGluZS5JbnN0YW5jZSA9IEluc3RhbmNlXG4iXX0=

*/
